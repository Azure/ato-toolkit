{
  "properties": {
    "template": {
      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "resourcePrefix": {
          "type": "string",
          "metadata": {
            "displayName": "Resource Group and Resource identifier. String to be used as prefix to all Resource Group and Resource names."
          }
        },
        "jumpbox-local-admin-username": {
          "type": "string",
          "metadata": {
            "displayName": "Jumpbox admin username",
            "description": "The username used to access jumpbox VMs"
          },
          "defaultValue": "jb-admin-user"
        },
        "jumpbox-os": {
          "type": "string",
          "metadata": {
            "displayName": "Jumpbox Operating System",
            "description": "Choose between Linux or Windows"
          },
          "allowedValues": [
            "Windows",
            "Linux"
          ],
          "defaultValue": "Windows"
        },
        "linux-authentication-type": {
          "type": "string",
          "metadata": {
            "displayName": "For a Linux jumpbox, use password or ssh",
            "description": "For a Linux jumpbox, choose whether the account will use username/password or SSH keys for authentication. A Windows jumpbox will use password regardless of what is selected."
          },
          "defaultValue": "Password",
          "allowedValues": [
            "Password",
            "SSH"
          ]
        },
        "linux-admin-ssh": {
          "type": "string",
          "defaultValue": "",
          "metadata": {
            "displayName": "Linux admin ssh key",
            "description": "For a Linux jumpbox, if SSH is selected as the authentication type, enter the SSH public key. Otherwise this value will be ignored"
          }
        },
        "stig-scripts-base-uri": {
          "type": "string",
          "defaultValue": "https://raw.githubusercontent.com/alexholco/ztascripts/master/scripts/",
          "metadata": {
            "displayName": "URI location of the STIG scripts",
            "description": "URI to the location of the folder which contains /linux-stigs/<stig-script>. This value MUST inclue the trailing slash."
          }
        },
        "stig-script-name": {
          "type": "string",
          "defaultValue": "rhel7-script-stig.sh",
          "metadata": {
            "displayName": "STIG script name",
            "description": "Name of the STIG script"
          }
        },
        "logs-retention-in-days": {
          "type": "int",
          "metadata": {
            "displayName": "Log retention in days",
            "description": "Specifies the number of days that logs will be kept for; a value of 0 will retain data indefinitely"
          },
          "defaultValue": 365,
          "minValue": 0,
          "maxValue": 365
        },
        "utcValue": {
          "type": "string",
          "defaultValue": "[utcNow()]"
        },
        "artifact-storage-account-uri": {
          "type": "string",
          "metadata": {
            "displayName": "URI location of the STIG scripts",
            "description": "URI to the location of the folder which contains /online/<stig-scripts> OR /offline/<stig-scripts>. This value must NOT include a trailing slash."
          }
        },
        "isOffline": {
          "type": "bool",
          "defaultValue": false
        },
        "disk-encryption-type": {
          "type": "string",
          "metadata": {
            "displayName": "For Disk Encryption with Customer Managed Key (CMK), use Server Side Encryption (SSE) or Azure Disk Encryption (ADE)",
            "description": "For Disk Encryption with Customer Managed Key (CMK), choose whether the disk should be encrypted with SSE + CMK or ADE + CMK"
          },
          "allowedValues": [
            "SSE",
            "ADE"
          ]
        },
        "noLogAnalytics": {
          "type": "bool",
          "defaultValue": true
        }
      },
      "variables": {
        "deployment-prefix": "[concat(parameters('resourcePrefix'), '-sharedsvcs')]",
        "extension-name": "jb",
        "virtualMachine-size": "[if(equals(parameters('jumpbox-os'), 'Windows'), 'Standard_DS2_v2','Standard_F4s')]",
        "resource-prefix": "[concat(variables('deployment-prefix'), '-', variables('extension-name'))]",
        "oms-workspace-resourceGroup": "[concat(variables('deployment-prefix'), '-rg')]",
        "oms-workspace-name": "[concat(variables('deployment-prefix'), '-log')]",
        "vnet-resourceGroup": "[concat(variables('deployment-prefix'), '-rg')]",
        "vnet-name": "[concat(variables('deployment-prefix'), '-vnet')]",
        "azure-fw-name": "[concat(variables('deployment-prefix'), '-az-fw')]",
        "azure-fw-pip-name": "[concat(variables('deployment-prefix'), '-az-fw-pip')]",
        "jb-resourceGroup": "[concat(variables('deployment-prefix'), '-rg')]",
        "windows-availabilitySet-name": "[concat(variables('resource-prefix'), '-win-as')]",
        "windows-virtualMachine-name-prefix": "[concat(variables('resource-prefix'), '-win-vm')]",
        "linux-virtualMachine-name-prefix": "[concat(variables('resource-prefix'), '-linux-vm')]",
        "linux-availabilitySet-name": "[concat(variables('resource-prefix'), '-linux-as')]",
        "bastion-subnet-id": "[concat(resourceId(variables('vnet-resourceGroup'), 'Microsoft.Network/virtualNetworks',  variables('vnet-name')), '/subnets/', 'bastion')]",
        "sharedsvc-subnet-id": "[concat(resourceId(variables('vnet-resourceGroup'), 'Microsoft.Network/virtualNetworks',  variables('vnet-name')), '/subnets/', 'sharedsvcs')]",
        "antimalware-extension-name": "IaaSAntimalware",
        "diagnostics-extension-name": "IaaSDiagnostics",
        "networkWatcher-extension-name": "NetworkWatcher",
        "uniqueString": "[uniqueString(subscription().id, concat(variables('deployment-prefix'), '-log'))]",
        "diagnostic-storageAccount-prefix": "[concat(replace(variables('deployment-prefix'), '-', ''), 'diag')]",
        "diagnostic-storageAccount-name": "[toLower(substring(replace(concat(variables('diagnostic-storageAccount-prefix'), variables('uniqueString'), variables('uniqueString')), '-', ''), 0, 23) )]",
        "diagnostic-storageAccount-id": "[resourceId(variables('oms-workspace-resourceGroup'), 'Microsoft.Storage/storageAccounts/', variables('diagnostic-storageAccount-name'))]",
        "wad-logs": "<WadCfg> <DiagnosticMonitorConfiguration overallQuotaInMB=\"4096\" xmlns=\"http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration\"> <DiagnosticInfrastructureLogs scheduledTransferLogLevelFilter=\"Error\"/> <WindowsEventLog scheduledTransferPeriod=\"PT1M\" > <DataSource name=\"Application!*[System[(Level = 1 or Level = 2)]]\" /> <DataSource name=\"Security!*[System[(Level = 1 or Level = 2)]]\" /> <DataSource name=\"System!*[System[(Level = 1 or Level = 2)]]\" /></WindowsEventLog>",
        "wad-perf-counters1": "<PerformanceCounters scheduledTransferPeriod=\"PT1M\"><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% Processor Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU utilization\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% Privileged Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU privileged time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% User Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU user time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor Information(_Total)\\Processor Frequency\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"CPU frequency\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\System\\Processes\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Processes\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Process(_Total)\\Thread Count\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Threads\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Process(_Total)\\Handle Count\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Handles\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\% Committed Bytes In Use\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Memory usage\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Available Bytes\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory available\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Committed Bytes\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory committed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Commit Limit\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory commit limit\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active time\" locale=\"en-us\"/></PerformanceCounterConfiguration>",
        "wad-perf-counters2": "<PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Read Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active read time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Write Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active write time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Transfers/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Reads/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk read operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Writes/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk write operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Read Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk read speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Write Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk write speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\LogicalDisk(_Total)\\% Free Space\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk free space (percentage)\" locale=\"en-us\"/></PerformanceCounterConfiguration></PerformanceCounters>",
        "wad-cfgx-start": "[concat(variables('wad-logs'), variables('wad-perf-counters1'), variables('wad-perf-counters2'), '<Metrics resourceId=\"')]",
        "wad-metrics-resource-id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name , '/providers/', 'Microsoft.Compute/virtualMachines/')]",
        "wad-cfgx-end": "\"><MetricAggregation scheduledTransferPeriod=\"PT1H\"/><MetricAggregation scheduledTransferPeriod=\"PT1M\"/></Metrics></DiagnosticMonitorConfiguration></WadCfg>",
        "jump-box-asg-id": "[resourceId(variables('vnet-resourceGroup'),'Microsoft.Network/applicationSecurityGroups', concat(variables('deployment-prefix'), '-jump-box-asg'))]",
        "sharedsvcs-asg-id": "[resourceId(variables('vnet-resourceGroup'),'Microsoft.Network/applicationSecurityGroups', concat(variables('deployment-prefix'), '-sharedsvcs-asg'))]",
        "pwd-min-length-config-name": "MinimumPasswordLength",
        "pwd-min-age-config-name": "MinimumPasswordAge",
        "pwd-not-last-24-config-name": "EnforcePasswordHistory",
        "pwd-without-reversible-encryption-config-name": "StorePasswordsUsingReversibleEncryption",
        "web-server-with-tls-1.1-config-name": "AuditSecureProtocol",
        "pwd-max-age-config-name": "MaximumPasswordAge",
        "pwd-complexity-config-name": "PasswordMustMeetComplexityRequirements",
        "linuxAzurePolicy": "AzurePolicyforLinux",
        "linuxOMSExtensionName": "MMAExtension",
        "linuxOMSExtensionPublisher": "Microsoft.EnterpriseCloud.Monitoring",
        "linuxOMSExtensionType": "OmsAgentForLinux",
        "linuxOMSExtensionTypeHandlerVersion": "1.7",
        "linux-audit-remote-connection-with-no-pwd-config-name": "PasswordPolicy_msid110",
        "linux-audit-accounts-with-no-pwd-config-name": "PasswordPolicy_msid232",
        "linux-audit-etc-passwd-file-permission-set-to-0644-config-name": "PasswordPolicy_msid121",
        "local-policy-pwd-settings": "https://raw.githubusercontent.com/Azure/azure-blueprints/master/VDCArtifacts/local_policy_settings.ps1",
        "windows-password-policies-extension-name": "PwdPolicies",
        "windows-oms-extension-name": "MMAExtension",
        "windows-dependency-extension-name": "DependencyAgent",
        "windows-dependency-extension-publisher": "Microsoft.Azure.Monitoring.DependencyAgent",
        "windows-dependency-extension-type": "DependencyAgentWindows",
        "windows-dependency-extension-handler-version": "9.6",
        "max-password-age": 70,
        "min-password-age": 1,
        "min-password-length": 14,
        "pwd-history-count": 24,
        "windowsDiskEncryptionExtensionName": "AzureDiskEncryption",
        "windowsDiskEncryptionExtensionVersion": "2.2",
        "windowsEncryptionOperation": "EnableEncryption",
        "windowsKeyEncryptionAlgorithm": "RSA-OAEP",
        "linuxDiskEncryptionExtensionName": "AzureDiskEncryptionForLinux",
        "linuxUseDiskEncryption": false,
        "linuxDiskEncryptionExtensionVersion": "1.1",
        "linuxEncryptionOperation": "EnableEncryption",
        "linuxKeyEncryptionAlgorithm": "RSA-OAEP",
        "linuxStigExtensionName": "LinuxStigExtension",
        "folder-name": "[if(parameters('isOffline'), 'offline', 'online')]",
        "disa-stig-script": "rhel7.sh",
        "apply-stig-script": "apply-stigs.sh",
        "offline-archive": "offline-zta.tar.gz",
        "stig-files": [
          "[concat(parameters('artifact-storage-account-uri'), '/', variables('folder-name'), '/', variables('disa-stig-script'))]",
          "[concat(parameters('artifact-storage-account-uri'), '/', variables('folder-name'), '/', variables('apply-stig-script'))]"
        ],
        "archive-files": [
          "[concat(parameters('artifact-storage-account-uri'), '/', variables('folder-name'), '/', variables('offline-archive'))]"
        ],
        "file-uris": "[if(parameters('isOffline'), union(variables('stig-files'), variables('archive-files')), variables('stig-files'))]",
        "win-server-2019-dsc-extension-filename": "WindowsServer2019Workgroup.ps1.zip",
        "required-modules-filename": "RequiredModules.ps1",
        "install-powershell-modules-script-extension-filename": "DownloadPowerShellModules.ps1",
        "windows-custom-script-extension": "install-powershell-modules",
        "dsc-setup-win2019": "DSCSetupWin2019",
        "public-ip-address": "[concat(variables('resource-prefix'), '-win-vm-pip1')]",
        "public-ip-address-id": {
          "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('public-ip-address'))]"
        },
        "key-vault-name": "[concat(variables('deployment-prefix'), '-kv')]",
        "os-disk-name": "[replace(toLower(substring(concat(variables('windows-virtualMachine-name-prefix'), '-osdisk', '-', replace(concat(variables('uniqueString'), variables('uniqueString')), '-', '')), 0, 40)), '-', '')]",
        "disk-encryption-set-id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name , '/providers/', 'Microsoft.Compute/diskEncryptionSets/', variables('deployment-prefix'), '-disk-encryption-set')]",
        "managed-disk-json": {
          "storageAccountType": "Premium_LRS",
          "diskEncryptionSet": {
            "id": "[variables('disk-encryption-set-id')]"
          }
        },
        "is-integrated-with-stig": false
      },
      "resources": [
        {
          "type": "Microsoft.Compute/availabilitySets",
          "apiVersion": "2019-07-01",
          "condition": "[equals(parameters('jumpbox-os'), 'Windows')]",
          "location": "[resourceGroup().location]",
          "name": "[variables('windows-availabilitySet-name')]",
          "properties": {
            "platformFaultDomainCount": 2,
            "platformUpdateDomainCount": 5
          },
          "sku": {
            "name": "Aligned"
          }
        },
        {
          "type": "Microsoft.Network/networkInterfaces",
          "apiVersion": "2019-07-01",
          "condition": "[equals(parameters('jumpbox-os'), 'Windows')]",
          "dependsOn": [
            "[resourceId('Microsoft.Compute/availabilitySets/', variables('windows-availabilitySet-name'))]"
          ],
          "location": "[resourceGroup().location]",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '-bastion-nic')]",
          "properties": {
            "enableAcceleratedNetworking": true,
            "ipConfigurations": [
              {
                "name": "ipconfig1",
                "properties": {
                  "privateIPAllocationMethod": "Dynamic",
                  "subnet": {
                    "id": "[variables('bastion-subnet-id')]"
                  },
                  "applicationSecurityGroups": [
                    {
                      "id": "[variables('jump-box-asg-id')]"
                    }
                  ]
                }
              }
            ]
          }
        },
        {
          "type": "Microsoft.Network/networkInterfaces",
          "apiVersion": "2019-07-01",
          "condition": "[equals(parameters('jumpbox-os'), 'Windows')]",
          "location": "[resourceGroup().location]",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '-sharedsvc-nic')]",
          "properties": {
            "enableAcceleratedNetworking": true,
            "ipConfigurations": [
              {
                "name": "ipconfig2",
                "properties": {
                  "privateIPAllocationMethod": "Dynamic",
                  "subnet": {
                    "id": "[variables('sharedsvc-subnet-id')]"
                  },
                  "applicationSecurityGroups": [
                    {
                      "id": "[variables('jump-box-asg-id')]"
                    }
                  ]
                }
              }
            ]
          }
        },
        {
          "type": "Microsoft.Network/networkInterfaces/providers/diagnosticSettings",
          "apiVersion": "2017-05-01-preview",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '-bastion-nic', '/Microsoft.Insights/service')]",
          "location": "[resourceGroup().location]",
          "condition": "[equals(parameters('jumpbox-os'), 'Windows')]",
          "dependsOn": [
            "[concat(variables('windows-virtualMachine-name-prefix'), '-bastion-nic')]"
          ],
          "properties": {
            "storageAccountId": "[resourceId(variables('oms-workspace-resourceGroup'), 'Microsoft.Storage/storageAccounts', variables('diagnostic-storageAccount-name'))]",
            "workspaceId": "[if(parameters('noLogAnalytics'), json('null'), resourceId(variables('oms-workspace-resourceGroup'), 'Microsoft.OperationalInsights/workspaces', variables('oms-workspace-name')))]",
            "metrics": [
              {
                "category": "AllMetrics",
                "timeGrain": null,
                "enabled": true,
                "retentionPolicy": {
                  "enabled": true,
                  "days": "[parameters('logs-retention-in-days')]"
                }
              }
            ]
          }
        },
        {
          "type": "Microsoft.Network/networkInterfaces/providers/diagnosticSettings",
          "apiVersion": "2017-05-01-preview",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '-sharedsvc-nic', '/Microsoft.Insights/service')]",
          "location": "[resourceGroup().location]",
          "condition": "[equals(parameters('jumpbox-os'), 'Windows')]",
          "dependsOn": [
            "[concat(variables('windows-virtualMachine-name-prefix'), '-sharedsvc-nic')]"
          ],
          "properties": {
            "storageAccountId": "[resourceId(variables('oms-workspace-resourceGroup'), 'Microsoft.Storage/storageAccounts', variables('diagnostic-storageAccount-name'))]",
            "workspaceId": "[if(parameters('noLogAnalytics'), json('null'), resourceId(variables('oms-workspace-resourceGroup'), 'Microsoft.OperationalInsights/workspaces', variables('oms-workspace-name')))]",
            "metrics": [
              {
                "category": "AllMetrics",
                "timeGrain": null,
                "enabled": true,
                "retentionPolicy": {
                  "enabled": true,
                  "days": "[parameters('logs-retention-in-days')]"
                }
              }
            ]
          }
        },
        {
          "type": "Microsoft.Resources/deployments",
          "apiVersion": "2019-09-01",
          "condition": "[equals(parameters('jumpbox-os'), 'Windows')]",
          "name": "[variables('windows-virtualMachine-name-prefix')]",
          "dependsOn": [
            "[resourceId('Microsoft.Compute/availabilitySets', variables('windows-availabilitySet-name'))]",
            "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('windows-virtualMachine-name-prefix'), '-bastion-nic'))]",
            "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('windows-virtualMachine-name-prefix'), '-sharedsvc-nic'))]"
          ],
          "properties": {
            "mode": "Incremental",
            "expressionEvaluationOptions": {
              "scope": "inner"
            },
            "template": {
              "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
              "contentVersion": "1.0.0.0",
              "parameters": {
                "jumpbox-os": {
                  "type": "string"
                },
                "jumpbox-local-admin-password": {
                  "type": "securestring"
                },
                "jumpbox-local-admin-username": {
                  "type": "string"
                },
                "windows-virtualMachine-name-prefix": {
                  "type": "string"
                },
                "windows-availabilitySet-name": {
                  "type": "string"
                },
                "extension-name": {
                  "type": "string"
                },
                "virtualMachine-size": {
                  "type": "string"
                },
                "uniqueString": {
                  "type": "string"
                },
                "oms-workspace-resourceGroup": {
                  "type": "string"
                },
                "diagnostic-storageAccount-name": {
                  "type": "string"
                },
                "isOffline": {
                  "type": "bool"
                },
                "artifact-storage-account-uri": {
                  "type": "string"
                },
                "win-server-2019-dsc-extension-filename": {
                  "type": "string"
                },
                "required-modules-filename": {
                  "type": "string"
                },
                "install-powershell-modules-script-extension-filename": {
                  "type": "string"
                },
                "dsc-setup-win2019": {
                  "type": "string"
                },
                "windows-custom-script-extension": {
                  "type": "string"
                },
                "os-disk-name": {
                  "type": "string"
                },
                "managed-disk-json": {
                  "type": "object"
                },
                "disk-encryption-type": {
                  "type": "string"
                },
                "windowsDiskEncryptionExtensionName": {
                  "type": "string"
                },
                "windowsDiskEncryptionExtensionVersion": {
                  "type": "string"
                },
                "windowsKeyEncryptionAlgorithm": {
                  "type": "string"
                },
                "windowsEncryptionOperation": {
                  "type": "string"
                },
                "key-vault-name": {
                  "type": "string"
                },
                "utcValue": {
                  "type": "string"
                },
                "disk-key-encryption-key-url": {
                  "type": "string"
                }
              },
              "resources": [
                {
                  "type": "Microsoft.Compute/virtualMachines",
                  "identity": {
                    "type": "SystemAssigned"
                  },
                  "apiVersion": "2019-07-01",
                  "condition": "[equals(parameters('jumpbox-os'), 'Windows')]",
                  "location": "[resourceGroup().location]",
                  "name": "[parameters('windows-virtualMachine-name-prefix')]",
                  "properties": {
                    "availabilitySet": {
                      "id": "[resourceId('Microsoft.Compute/availabilitySets', parameters('windows-availabilitySet-name'))]"
                    },
                    "osProfile": {
                      "computerName": "[concat(parameters('extension-name'), '-win-vm')]",
                      "adminUsername": "[parameters('jumpbox-local-admin-username')]",
                      "adminPassword": "[parameters('jumpbox-local-admin-password')]"
                    },
                    "hardwareProfile": {
                      "vmSize": "[parameters('virtualMachine-size')]"
                    },
                    "storageProfile": {
                      "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2019-Datacenter",
                        "version": "latest"
                      },
                      "osDisk": {
                        "name": "[replace(toLower(substring(concat(parameters('windows-virtualMachine-name-prefix'), '-osdisk', '-', replace(concat(parameters('uniqueString'), parameters('uniqueString')), '-', '')), 0, 40)), '-', '')]",
                        "osType": "Windows",
                        "createOption": "FromImage",
                        "managedDisk": "[if(or(bool(equals(parameters('isOffline'), bool('true'))), bool(equals(parameters('disk-encryption-type'), 'ADE'))), json('null'), parameters('managed-disk-json'))]"
                      }
                    },
                    "networkProfile": {
                      "networkInterfaces": [
                        {
                          "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('windows-virtualMachine-name-prefix'), '-bastion-nic'))]",
                          "properties": {
                            "primary": true
                          }
                        },
                        {
                          "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('windows-virtualMachine-name-prefix'), '-sharedsvc-nic'))]",
                          "properties": {
                            "primary": false
                          }
                        }
                      ]
                    },
                    "diagnosticsProfile": {
                      "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[concat(reference(resourceId(parameters('oms-workspace-resourceGroup'), 'Microsoft.Storage/storageAccounts/', parameters('diagnostic-storageAccount-name')), '2019-06-01').primaryEndpoints.blob)]"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "extensions",
                      "name": "[parameters('windows-custom-script-extension')]",
                      "apiVersion": "2017-03-30",
                      "location": "[resourceGroup().location]",
                      "condition": "[not(parameters('isOffline'))]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(parameters('windows-virtualMachine-name-prefix')))]"
                      ],
                      "properties": {
                        "publisher": "Microsoft.Compute",
                        "type": "CustomScriptExtension",
                        "typeHandlerVersion": "1.10",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "fileUris": [
                            "[concat(parameters('artifact-storage-account-uri'), '/', parameters('required-modules-filename'))]",
                            "[concat(parameters('artifact-storage-account-uri'), '/', parameters('install-powershell-modules-script-extension-filename'))]"
                          ],
                          "timestamp": 123456788,
                          "commandToExecute": "[concat('PowerShell -ExecutionPolicy Unrestricted -File ', parameters('install-powershell-modules-script-extension-filename'))]"
                        }
                      }
                    },
                    {
                      "type": "extensions",
                      "name": "[concat(parameters('dsc-setup-win2019'), '-online')]",
                      "apiVersion": "2017-03-30",
                      "location": "[resourceGroup().location]",
                      "condition": "[not(parameters('isOffline'))]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(parameters('windows-virtualMachine-name-prefix')))]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(parameters('windows-virtualMachine-name-prefix')), parameters('windows-custom-script-extension'))]"
                      ],
                      "properties": {
                        "publisher": "Microsoft.Powershell",
                        "type": "DSC",
                        "typeHandlerVersion": "2.77",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "wmfVersion": "latest",
                          "configuration": {
                            "url": "[concat(parameters('artifact-storage-account-uri'), '/online/', parameters('win-server-2019-dsc-extension-filename'))]",
                            "script": "WindowsServer2019Workgroup.ps1",
                            "function": "WindowsServer2019Workgroup"
                          },
                          "configurationArguments": {
                            "IsOffline": "[parameters('isOffline')]"
                          }
                        }
                      }
                    },
                    {
                      "type": "extensions",
                      "name": "[concat(parameters('dsc-setup-win2019'), '-offline')]",
                      "apiVersion": "2017-03-30",
                      "location": "[resourceGroup().location]",
                      "condition": "[parameters('isOffline')]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', concat(parameters('windows-virtualMachine-name-prefix')))]"
                      ],
                      "properties": {
                        "publisher": "Microsoft.Powershell",
                        "type": "DSC",
                        "typeHandlerVersion": "2.77",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "wmfVersion": "latest",
                          "configuration": {
                            "url": "[concat(parameters('artifact-storage-account-uri'), '/offline/', parameters('win-server-2019-dsc-extension-filename'))]",
                            "script": "WindowsServer2019Workgroup.ps1",
                            "function": "WindowsServer2019Workgroup"
                          },
                          "configurationArguments": {
                            "IsOffline": "[parameters('isOffline')]"
                          }
                        }
                      }
                    }
                  ]
                },
                {
                  "type": "Microsoft.Compute/virtualMachines/extensions",
                  "name": "[concat('/', parameters('windows-virtualMachine-name-prefix'), '/', parameters('windowsDiskEncryptionExtensionName'))]",
                  "location": "[resourceGroup().location]",
                  "dependsOn": [
                    "[resourceId('Microsoft.Compute/virtualMachines', parameters('windows-virtualMachine-name-prefix'))]"
                  ],
                  "apiVersion": "2019-07-01",
                  "condition": "[and(bool(equals(parameters('jumpbox-os'), 'Windows')), bool(equals(parameters('disk-encryption-type'), 'ADE')), not(parameters('isOffline')))]",
                  "properties": {
                    "publisher": "Microsoft.Azure.Security",
                    "type": "[parameters('windowsDiskEncryptionExtensionName')]",
                    "typeHandlerVersion": "[parameters('windowsDiskEncryptionExtensionVersion')]",
                    "autoUpgradeMinorVersion": true,
                    "forceUpdateTag": "[parameters('utcValue')]",
                    "settings": {
                      "EncryptionOperation": "[parameters('windowsEncryptionOperation')]",
                      "KeyVaultURL": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('key-vault-name')), '2019-09-01').vaultUri]",
                      "KeyVaultResourceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('key-vault-name'))]",
                      "KeyEncryptionKeyURL": "[parameters('disk-key-encryption-key-url')]",
                      "KekVaultResourceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('key-vault-name'))]",
                      "KeyEncryptionAlgorithm": "[parameters('windowsKeyEncryptionAlgorithm')]",
                      "VolumeType": "All",
                      "ResizeOSDisk": false
                    }
                  }
                }
              ]
            },
            "parameters": {
              "jumpbox-os": {
                "value": "[parameters('jumpbox-os')]"
              },
              "jumpbox-local-admin-username": {
                "value": "[parameters('jumpbox-local-admin-username')]"
              },
              "windows-virtualMachine-name-prefix": {
                "value": "[variables('windows-virtualMachine-name-prefix')]"
              },
              "windows-availabilitySet-name": {
                "value": "[variables('windows-availabilitySet-name')]"
              },
              "extension-name": {
                "value": "[variables('extension-name')]"
              },
              "windows-custom-script-extension": {
                "value": "[variables('windows-custom-script-extension')]"
              },
              "jumpbox-local-admin-password": {
                "reference": {
                  "keyVault": {
                    "id": "[resourceId('Microsoft.KeyVault/vaults', variables('key-vault-name'))]"
                  },
                  "secretName": "jb-admin-user-password"
                }
              },
              "disk-key-encryption-key-url": {
                "reference": {
                  "keyVault": {
                    "id": "[resourceId('Microsoft.KeyVault/vaults', variables('key-vault-name'))]"
                  },
                  "secretName": "disk-key-kek-kid"
                }
              },
              "virtualMachine-size": {
                "value": "[variables('virtualMachine-size')]"
              },
              "oms-workspace-resourceGroup": {
                "value": "[variables('oms-workspace-resourceGroup')]"
              },
              "uniqueString": {
                "value": "[variables('uniqueString')]"
              },
              "diagnostic-storageAccount-name": {
                "value": "[variables('diagnostic-storageAccount-name')]"
              },
              "required-modules-filename": {
                "value": "[variables('required-modules-filename')]"
              },
              "install-powershell-modules-script-extension-filename": {
                "value": "[variables('install-powershell-modules-script-extension-filename')]"
              },
              "win-server-2019-dsc-extension-filename": {
                "value": "[variables('win-server-2019-dsc-extension-filename')]"
              },
              "dsc-setup-win2019": {
                "value": "[variables('dsc-setup-win2019')]"
              },
              "artifact-storage-account-uri": {
                "value": "[parameters('artifact-storage-account-uri')]"
              },
              "os-disk-name": {
                "value": "[variables('os-disk-name')]"
              },
              "managed-disk-json": {
                "value": "[variables('managed-disk-json')]"
              },
              "disk-encryption-type": {
                "value": "[parameters('disk-encryption-type')]"
              },
              "windowsDiskEncryptionExtensionName": {
                "value": "[variables('windowsDiskEncryptionExtensionName')]"
              },
              "windowsDiskEncryptionExtensionVersion": {
                "value": "[variables('windowsDiskEncryptionExtensionVersion')]"
              },
              "windowsKeyEncryptionAlgorithm": {
                "value": "[variables('windowsKeyEncryptionAlgorithm')]"
              },
              "windowsEncryptionOperation": {
                "value": "[variables('windowsEncryptionOperation')]"
              },
              "key-vault-name": {
                "value": "[variables('key-vault-name')]"
              },
              "utcValue": {
                "value": "[parameters('utcValue')]"
              },
              "isOffline": {
                "value": "[parameters('isOffline')]"
              }
            }
          }
        },
        {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "name": "[concat('/', variables('windows-virtualMachine-name-prefix'), '/', variables('windows-oms-extension-name'))]",
          "apiVersion": "2019-07-01",
          "condition": "[and(equals(parameters('jumpbox-os'), 'Windows'), not(parameters('isOffline')))]",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix'))]"
          ],
          "properties": {
            "publisher": "Microsoft.EnterpriseCloud.Monitoring",
            "type": "MicrosoftMonitoringAgent",
            "typeHandlerVersion": "1.0",
            "autoUpgradeMinorVersion": true,
            "settings": {
              "workspaceId": "[if(parameters('isOffline'), '', reference(resourceId(variables('oms-workspace-resourceGroup'), 'Microsoft.OperationalInsights/workspaces', variables('oms-workspace-name')), '2015-03-20').customerId)]"
            },
            "protectedSettings": {
              "workspaceKey": "[if(parameters('isOffline'), '', listKeys(resourceId(variables('oms-workspace-resourceGroup'), 'Microsoft.OperationalInsights/workspaces', variables('oms-workspace-name')), '2015-03-20').primarySharedKey)]"
            }
          }
        },
        {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '/', variables('antimalware-extension-name'))]",
          "condition": "[equals(parameters('jumpbox-os'), 'Windows')]",
          "apiVersion": "2019-07-01",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('windows-oms-extension-name'))]"
          ],
          "properties": {
            "publisher": "Microsoft.Azure.Security",
            "type": "IaaSAntimalware",
            "typeHandlerVersion": "1.5",
            "autoUpgradeMinorVersion": true,
            "settings": {
              "AntimalwareEnabled": true,
              "RealtimeProtectionEnabled": "true",
              "ScheduledScanSettings": {
                "isEnabled": "true",
                "scanType": "Quick",
                "day": "7",
                "time": "120"
              }
            }
          }
        },
        {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '/', variables('diagnostics-extension-name'))]",
          "condition": "[equals(parameters('jumpbox-os'), 'Windows')]",
          "location": "[resourceGroup().location]",
          "apiVersion": "2019-07-01",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix'))]"
          ],
          "properties": {
            "publisher": "Microsoft.Azure.Diagnostics",
            "type": "IaaSDiagnostics",
            "typeHandlerVersion": "1.5",
            "autoUpgradeMinorVersion": true,
            "settings": {
              "xmlCfg": "[base64(concat(variables('wad-cfgx-start'), variables('wad-metrics-resource-id'), variables('windows-virtualMachine-name-prefix'), variables('wad-cfgx-end')))]",
              "storageAccount": "[variables('diagnostic-storageAccount-name')]"
            },
            "protectedSettings": {
              "storageAccountName": "[variables('diagnostic-storageAccount-name')]",
              "storageAccountKey": "[listkeys(variables('diagnostic-storageAccount-id'), '2019-06-01').keys[0])",
              "storageAccountEndPoint": "[replace(reference(variables('diagnostic-storageAccount-id'), '2019-06-01').primaryEndpoints.blob, concat(variables('diagnostic-storageAccount-name'), '.blob.'), '')]"
            }
          }
        },
        {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '/', variables('networkWatcher-extension-name'))]",
          "condition": "[equals(parameters('jumpbox-os'), 'Windows')]",
          "apiVersion": "2019-07-01",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix'))]"
          ],
          "properties": {
            "publisher": "Microsoft.Azure.NetworkWatcher",
            "type": "NetworkWatcherAgentWindows",
            "typeHandlerVersion": "1.4",
            "autoUpgradeMinorVersion": true
          }
        },
        {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '/', variables('windows-password-policies-extension-name'))]",
          "apiVersion": "2019-07-01",
          "condition": "[and(equals(parameters('jumpbox-os'), 'Windows'), variables('is-integrated-with-stig'), not(parameters('isOffline')))]",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix'))]"
          ],
          "properties": {
            "publisher": "Microsoft.Compute",
            "type": "CustomScriptExtension",
            "typeHandlerVersion": "1.8",
            "autoUpgradeMinorVersion": true,
            "settings": {
              "fileUris": [
                "[variables('local-policy-pwd-settings')]"
              ],
              "commandToExecute": "[concat('powershell -ExecutionPolicy Unrestricted -File ./local_policy_settings.ps1 -MaxPwdAge ', variables('max-password-age'), ' -MinPwdAge ', variables('min-password-age'), ' -MinPwdLength ', variables('min-password-length'), ' -PwdHistoryCount ', variables('pwd-history-count'))]",
              "timestamp": 123456789
            }
          }
        },
        {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '/', variables('windows-dependency-extension-name'))]",
          "apiVersion": "2019-07-01",
          "condition": "[and(equals(parameters('jumpbox-os'), 'Windows'), not(parameters('isOffline')))]",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix'))]"
          ],
          "properties": {
            "publisher": "[variables('windows-dependency-extension-publisher')]",
            "type": "[variables('windows-dependency-extension-type')]",
            "typeHandlerVersion": "[variables('windows-dependency-extension-handler-version')]",
            "autoUpgradeMinorVersion": true
          }
        },
        {
          "type": "Microsoft.Compute/virtualMachines/providers/diagnosticSettings",
          "apiVersion": "2017-05-01-preview",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '/Microsoft.Insights/service')]",
          "location": "[resourceGroup().location]",
          "condition": "[equals(parameters('jumpbox-os'), 'Windows')]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix'))]"
          ],
          "properties": {
            "storageAccountId": "[resourceId(variables('oms-workspace-resourceGroup'), 'Microsoft.Storage/storageAccounts', variables('diagnostic-storageAccount-name'))]",
            "workspaceId": "[if(parameters('noLogAnalytics'), json('null'), resourceId(variables('oms-workspace-resourceGroup'), 'Microsoft.OperationalInsights/workspaces', variables('oms-workspace-name')))]",
            "metrics": [
              {
                "category": "AllMetrics",
                "enabled": true,
                "retentionPolicy": {
                  "enabled": true,
                  "days": "[parameters('logs-retention-in-days')]"
                }
              }
            ],
            "logs": []
          }
        },
        {
          "apiVersion": "2018-11-20",
          "type": "Microsoft.Compute/virtualMachines/providers/guestConfigurationAssignments",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '/Microsoft.GuestConfiguration/', variables('pwd-min-length-config-name'))]",
          "condition": "[and(equals(parameters('jumpbox-os'), 'Windows'), not(parameters('isOffline')))]",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('antimalware-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('diagnostics-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('networkWatcher-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('windows-oms-extension-name'))]"
          ],
          "properties": {
            "guestConfiguration": {
              "name": "[variables('pwd-min-length-config-name')]",
              "version": "1.*"
            }
          }
        },
        {
          "apiVersion": "2018-11-20",
          "type": "Microsoft.Compute/virtualMachines/providers/guestConfigurationAssignments",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '/Microsoft.GuestConfiguration/', variables('pwd-min-age-config-name'))]",
          "condition": "[and(equals(parameters('jumpbox-os'), 'Windows'), not(parameters('isOffline')))]",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('antimalware-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('diagnostics-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('networkWatcher-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('windows-oms-extension-name'))]"
          ],
          "properties": {
            "guestConfiguration": {
              "name": "[variables('pwd-min-age-config-name')]",
              "version": "1.*"
            }
          }
        },
        {
          "apiVersion": "2018-11-20",
          "type": "Microsoft.Compute/virtualMachines/providers/guestConfigurationAssignments",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '/Microsoft.GuestConfiguration/', variables('pwd-not-last-24-config-name'))]",
          "condition": "[and(equals(parameters('jumpbox-os'), 'Windows'), not(parameters('isOffline')))]",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('antimalware-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('diagnostics-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('networkWatcher-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('windows-oms-extension-name'))]"
          ],
          "properties": {
            "guestConfiguration": {
              "name": "[variables('pwd-not-last-24-config-name')]",
              "version": "1.*"
            }
          }
        },
        {
          "apiVersion": "2018-11-20",
          "type": "Microsoft.Compute/virtualMachines/providers/guestConfigurationAssignments",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '/Microsoft.GuestConfiguration/', variables('pwd-without-reversible-encryption-config-name'))]",
          "condition": "[and(equals(parameters('jumpbox-os'), 'Windows'), not(parameters('isOffline')))]",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('antimalware-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('diagnostics-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('networkWatcher-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('windows-oms-extension-name'))]"
          ],
          "properties": {
            "guestConfiguration": {
              "name": "[variables('pwd-without-reversible-encryption-config-name')]",
              "version": "1.*"
            }
          }
        },
        {
          "apiVersion": "2018-11-20",
          "type": "Microsoft.Compute/virtualMachines/providers/guestConfigurationAssignments",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '/Microsoft.GuestConfiguration/', variables('web-server-with-tls-1.1-config-name'))]",
          "condition": "[and(equals(parameters('jumpbox-os'), 'Windows'), not(parameters('isOffline')))]",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('antimalware-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('diagnostics-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('networkWatcher-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('windows-oms-extension-name'))]"
          ],
          "properties": {
            "guestConfiguration": {
              "name": "[variables('web-server-with-tls-1.1-config-name')]",
              "version": "1.*"
            }
          }
        },
        {
          "apiVersion": "2018-11-20",
          "type": "Microsoft.Compute/virtualMachines/providers/guestConfigurationAssignments",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '/Microsoft.GuestConfiguration/', variables('pwd-max-age-config-name'))]",
          "condition": "[and(equals(parameters('jumpbox-os'), 'Windows'), not(parameters('isOffline')))]",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('antimalware-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('diagnostics-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('networkWatcher-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('windows-oms-extension-name'))]"
          ],
          "properties": {
            "guestConfiguration": {
              "name": "[variables('pwd-max-age-config-name')]",
              "version": "1.*"
            }
          }
        },
        {
          "apiVersion": "2018-11-20",
          "type": "Microsoft.Compute/virtualMachines/providers/guestConfigurationAssignments",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '/Microsoft.GuestConfiguration/', variables('pwd-complexity-config-name'))]",
          "condition": "[and(equals(parameters('jumpbox-os'), 'Windows'), not(parameters('isOffline')))]",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('antimalware-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('diagnostics-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('networkWatcher-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('windows-oms-extension-name'))]"
          ],
          "properties": {
            "guestConfiguration": {
              "name": "[variables('pwd-complexity-config-name')]",
              "version": "1.*"
            }
          }
        },
        {
          "apiVersion": "2019-07-01",
          "name": "[concat(variables('windows-virtualMachine-name-prefix'), '/AzurePolicyforWindows')]",
          "condition": "[and(equals(parameters('jumpbox-os'), 'Windows'), not(parameters('isOffline')))]",
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix'))]",
            "[concat('Microsoft.Compute/virtualMachines/',variables('windows-virtualMachine-name-prefix'),'/providers/Microsoft.GuestConfiguration/guestConfigurationAssignments/',variables('pwd-min-length-config-name'))]",
            "[concat('Microsoft.Compute/virtualMachines/',variables('windows-virtualMachine-name-prefix'),'/providers/Microsoft.GuestConfiguration/guestConfigurationAssignments/',variables('pwd-min-age-config-name'))]",
            "[concat('Microsoft.Compute/virtualMachines/',variables('windows-virtualMachine-name-prefix'),'/providers/Microsoft.GuestConfiguration/guestConfigurationAssignments/',variables('pwd-not-last-24-config-name'))]",
            "[concat('Microsoft.Compute/virtualMachines/',variables('windows-virtualMachine-name-prefix'),'/providers/Microsoft.GuestConfiguration/guestConfigurationAssignments/',variables('pwd-without-reversible-encryption-config-name'))]",
            "[concat('Microsoft.Compute/virtualMachines/',variables('windows-virtualMachine-name-prefix'),'/providers/Microsoft.GuestConfiguration/guestConfigurationAssignments/',variables('web-server-with-tls-1.1-config-name'))]",
            "[concat('Microsoft.Compute/virtualMachines/',variables('windows-virtualMachine-name-prefix'),'/providers/Microsoft.GuestConfiguration/guestConfigurationAssignments/',variables('pwd-max-age-config-name'))]",
            "[concat('Microsoft.Compute/virtualMachines/',variables('windows-virtualMachine-name-prefix'),'/providers/Microsoft.GuestConfiguration/guestConfigurationAssignments/',variables('pwd-complexity-config-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('antimalware-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('diagnostics-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('networkWatcher-extension-name'))]",
            "[resourceId('Microsoft.Compute/virtualMachines/extensions', variables('windows-virtualMachine-name-prefix'), variables('windows-oms-extension-name'))]"
          ],
          "properties": {
            "publisher": "Microsoft.GuestConfiguration",
            "type": "ConfigurationforWindows",
            "typeHandlerVersion": "1.1",
            "autoUpgradeMinorVersion": true,
            "settings": {},
            "protectedSettings": {}
          }
        },
        {
          "type": "Microsoft.Compute/availabilitySets",
          "apiVersion": "2019-07-01",
          "condition": "[equals(parameters('jumpbox-os'), 'Linux')]",
          "location": "[resourceGroup().location]",
          "name": "[variables('linux-availabilitySet-name')]",
          "properties": {
            "platformFaultDomainCount": 2,
            "platformUpdateDomainCount": 5
          },
          "sku": {
            "name": "Aligned"
          }
        },
        {
          "type": "Microsoft.Network/networkInterfaces",
          "apiVersion": "2017-09-01",
          "condition": "[equals(parameters('jumpbox-os'), 'Linux')]",
          "location": "[resourceGroup().location]",
          "name": "[concat(variables('linux-virtualMachine-name-prefix'), '-bastion-nic')]",
          "properties": {
            "enableAcceleratedNetworking": true,
            "ipConfigurations": [
              {
                "name": "ipconfig1",
                "properties": {
                  "primary": true,
                  "privateIPAllocationMethod": "Dynamic",
                  "subnet": {
                    "id": "[variables('bastion-subnet-id')]"
                  },
                  "applicationSecurityGroups": [
                    {
                      "id": "[variables('jump-box-asg-id')]"
                    }
                  ]
                }
              }
            ]
          }
        },
        {
          "type": "Microsoft.Network/networkInterfaces",
          "apiVersion": "2017-09-01",
          "condition": "[equals(parameters('jumpbox-os'), 'Linux')]",
          "location": "[resourceGroup().location]",
          "name": "[concat(variables('linux-virtualMachine-name-prefix'), '-sharedsvc-nic')]",
          "properties": {
            "enableAcceleratedNetworking": true,
            "ipConfigurations": [
              {
                "name": "ipconfig1",
                "properties": {
                  "primary": false,
                  "privateIPAllocationMethod": "Dynamic",
                  "subnet": {
                    "id": "[variables('sharedsvc-subnet-id')]"
                  },
                  "applicationSecurityGroups": [
                    {
                      "id": "[variables('jump-box-asg-id')]"
                    }
                  ]
                }
              }
            ]
          }
        },
        {
          "type": "Microsoft.Network/networkInterfaces/providers/diagnosticSettings",
          "apiVersion": "2017-05-01-preview",
          "name": "[concat(variables('linux-virtualMachine-name-prefix'), '-bastion-nic', '/Microsoft.Insights/service')]",
          "location": "[resourceGroup().location]",
          "condition": "[equals(parameters('jumpbox-os'), 'Linux')]",
          "dependsOn": [
            "[concat(variables('linux-virtualMachine-name-prefix'), '-bastion-nic')]"
          ],
          "properties": {
            "storageAccountId": "[resourceId(variables('oms-workspace-resourceGroup'), 'Microsoft.Storage/storageAccounts', variables('diagnostic-storageAccount-name'))]",
            "workspaceId": "[if(parameters('noLogAnalytics'), json('null'), resourceId(variables('oms-workspace-resourceGroup'), 'Microsoft.OperationalInsights/workspaces', variables('oms-workspace-name')))]",
            "metrics": [
              {
                "category": "AllMetrics",
                "timeGrain": null,
                "enabled": true,
                "retentionPolicy": {
                  "enabled": true,
                  "days": "[parameters('logs-retention-in-days')]"
                }
              }
            ]
          }
        },
        {
          "type": "Microsoft.Network/networkInterfaces/providers/diagnosticSettings",
          "apiVersion": "2017-05-01-preview",
          "name": "[concat(variables('linux-virtualMachine-name-prefix'), '-sharedsvc-nic', '/Microsoft.Insights/service')]",
          "location": "[resourceGroup().location]",
          "condition": "[equals(parameters('jumpbox-os'), 'Linux')]",
          "dependsOn": [
            "[concat(variables('linux-virtualMachine-name-prefix'), '-sharedsvc-nic')]"
          ],
          "properties": {
            "storageAccountId": "[resourceId(variables('oms-workspace-resourceGroup'), 'Microsoft.Storage/storageAccounts', variables('diagnostic-storageAccount-name'))]",
            "workspaceId": "[if(parameters('noLogAnalytics'), json('null'), resourceId(variables('oms-workspace-resourceGroup'), 'Microsoft.OperationalInsights/workspaces', variables('oms-workspace-name')))]",
            "metrics": [
              {
                "category": "AllMetrics",
                "timeGrain": null,
                "enabled": true,
                "retentionPolicy": {
                  "enabled": true,
                  "days": "[parameters('logs-retention-in-days')]"
                }
              }
            ]
          }
        },
        {
          "type": "Microsoft.Resources/deployments",
          "apiVersion": "2019-09-01",
          "condition": "[equals(parameters('jumpbox-os'), 'Linux')]",
          "name": "[variables('linux-virtualMachine-name-prefix')]",
          "dependsOn": [
            "[resourceId('Microsoft.Compute/availabilitySets', variables('linux-availabilitySet-name'))]",
            "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('linux-virtualMachine-name-prefix'), '-bastion-nic'))]",
            "[resourceId('Microsoft.Network/networkInterfaces', concat(variables('linux-virtualMachine-name-prefix'), '-sharedsvc-nic'))]"
          ],
          "properties": {
            "mode": "Incremental",
            "expressionEvaluationOptions": {
              "scope": "inner"
            },
            "template": {
              "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
              "contentVersion": "1.0.0.0",
              "parameters": {
                "jumpbox-os": {
                  "type": "string"
                },
                "jumpbox-local-admin-password": {
                  "type": "securestring"
                },
                "jumpbox-local-admin-username": {
                  "type": "string"
                },
                "linux-authentication-type": {
                  "type": "string"
                },
                "linux-admin-ssh": {
                  "type": "string"
                },
                "linux-virtualMachine-name-prefix": {
                  "type": "string"
                },
                "virtualMachine-size": {
                  "type": "string"
                },
                "uniqueString": {
                  "type": "string"
                },
                "oms-workspace-resourceGroup": {
                  "type": "string"
                },
                "diagnostic-storageAccount-name": {
                  "type": "string"
                },
                "linux-availabilitySet-name": {
                  "type": "string"
                },
                "extension-name": {
                  "type": "string"
                },
                "managed-disk-json": {
                  "type": "object"
                },
                "disk-encryption-type": {
                  "type": "string"
                },
                "linuxDiskEncryptionExtensionName": {
                  "type": "string"
                },
                "linuxDiskEncryptionExtensionVersion": {
                  "type": "string"
                },
                "linuxUseDiskEncryption": {
                  "type": "bool"
                },
                "linuxEncryptionOperation": {
                  "type": "string"
                },
                "linuxKeyEncryptionAlgorithm": {
                  "type": "string"
                },
                "key-vault-name": {
                  "type": "string"
                },
                "utcValue": {
                  "type": "string"
                },
                "disk-key-encryption-key-url": {
                  "type": "string"
                },
                "linuxOMSExtensionName": {
                  "type": "string"
                },
                "linuxOMSExtensionType": {
                  "type": "string"
                },
                "linuxOMSExtensionTypeHandlerVersion": {
                  "type": "string"
                },
                "linuxOMSExtensionPublisher": {
                  "type": "string"
                },
                "linux-audit-remote-connection-with-no-pwd-config-name": {
                  "type": "string"
                },
                "oms-workspace-name": {
                  "type": "string"
                },
                "linux-audit-accounts-with-no-pwd-config-name": {
                  "type": "string"
                },
                "linux-audit-etc-passwd-file-permission-set-to-0644-config-name": {
                  "type": "string"
                },
                "linuxAzurePolicy": {
                  "type": "string"
                },
                "linuxStigExtensionName": {
                  "type": "string"
                },
                "apply-stig-script": {
                  "type": "string"
                },
                "file-uris": {
                  "type": "array"
                },
                "logs-retention-in-days": {
                  "type": "int"
                },
                "stig-script-name": {
                  "type": "string"
                },
                "isOffline": {
                  "type": "bool"
                }
              },
              "variables": {
                "os-profile-ssh": {
                  "disablePasswordAuthentication": true,
                  "ssh": {
                    "publicKeys": [
                      {
                        "path": "[concat('/home/', parameters('jumpbox-local-admin-username'), '/.ssh/authorized_keys')]",
                        "keyData": "[parameters('linux-admin-ssh')]"
                      }
                    ]
                  }
                }
              },
              "resources": [
                {
                  "type": "Microsoft.Compute/virtualMachines",
                  "identity": {
                    "type": "SystemAssigned"
                  },
                  "apiVersion": "2019-07-01",
                  "condition": "[equals(parameters('jumpbox-os'), 'Linux')]",
                  "location": "[resourceGroup().location]",
                  "name": "[parameters('linux-virtualMachine-name-prefix')]",
                  "properties": {
                    "availabilitySet": {
                      "id": "[resourceId('Microsoft.Compute/availabilitySets', parameters('linux-availabilitySet-name'))]"
                    },
                    "osProfile": {
                      "computerName": "[concat(parameters('extension-name'), '-linux-vm')]",
                      "adminUsername": "[parameters('jumpbox-local-admin-username')]",
                      "adminPassword": "[parameters('jumpbox-local-admin-password')]",
                      "linuxConfiguration": "[if(equals(parameters('linux-authentication-type'), 'Password'), json('null'), variables('os-profile-ssh'))]"
                    },
                    "hardwareProfile": {
                      "vmSize": "[parameters('virtualMachine-size')]"
                    },
                    "storageProfile": {
                      "imageReference": {
                        "publisher": "OpenLogic",
                        "offer": "CentOS",
                        "sku": "7.7",
                        "version": "latest"
                      },
                      "osDisk": {
                        "name": "[replace(toLower(substring(concat(parameters('linux-virtualMachine-name-prefix'), '-osdisk', '-', replace(concat(parameters('uniqueString'), parameters('uniqueString')), '-', '')), 0, 40)), '-', '')]",
                        "osType": "Linux",
                        "createOption": "FromImage",
                        "managedDisk": "[if(or(bool(equals(parameters('isOffline'), bool('true'))), bool(equals(parameters('disk-encryption-type'), 'ADE'))), json('null'), parameters('managed-disk-json'))]"
                      }
                    },
                    "networkProfile": {
                      "networkInterfaces": [
                        {
                          "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('linux-virtualMachine-name-prefix'), '-bastion-nic'))]",
                          "properties": {
                            "primary": true
                          }
                        },
                        {
                          "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('linux-virtualMachine-name-prefix'), '-sharedsvc-nic'))]",
                          "properties": {
                            "primary": false
                          }
                        }
                      ]
                    },
                    "diagnosticsProfile": {
                      "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[concat(reference(resourceId(parameters('oms-workspace-resourceGroup'), 'Microsoft.Storage/storageAccounts/', parameters('diagnostic-storageAccount-name')), '2019-06-01').primaryEndpoints.blob)]"
                      }
                    }
                  }
                },
                {
                  "name": "[concat(parameters('linux-virtualMachine-name-prefix'), '/', parameters('linuxOMSExtensionName'))]",
                  "type": "Microsoft.Compute/virtualMachines/extensions",
                  "dependsOn": [
                    "[resourceId('Microsoft.Compute/virtualMachines', parameters('linux-virtualMachine-name-prefix'))]"
                  ],
                  "location": "[resourceGroup().location]",
                  "condition": "[and(equals(parameters('jumpbox-os'), 'Linux'), not(parameters('isOffline')))]",
                  "apiVersion": "2019-07-01",
                  "properties": {
                    "publisher": "[parameters('linuxOMSExtensionPublisher')]",
                    "type": "[parameters('linuxOMSExtensionType')]",
                    "typeHandlerVersion": "[parameters('linuxOMSExtensionTypeHandlerVersion')]",
                    "autoUpgradeMinorVersion": true,
                    "settings": {
                      "workspaceId": "[if(parameters('isOffline'), '', reference(resourceId(parameters('oms-workspace-resourceGroup'), 'Microsoft.OperationalInsights/workspaces', parameters('oms-workspace-name')), '2015-03-20').customerId)]",
                      "stopOnMultipleConnections": "true"
                    },
                    "protectedSettings": {
                      "workspaceKey": "[if(parameters('isOffline'), '', listKeys(resourceId(parameters('oms-workspace-resourceGroup'), 'Microsoft.OperationalInsights/workspaces', parameters('oms-workspace-name')), '2015-03-20').primarySharedKey)]"
                    }
                  }
                },
                {
                  "type": "Microsoft.Compute/virtualMachines/providers/diagnosticSettings",
                  "apiVersion": "2017-05-01-preview",
                  "name": "[concat(parameters('linux-virtualMachine-name-prefix'), '/Microsoft.Insights/service')]",
                  "location": "[resourceGroup().location]",
                  "condition": "[equals(parameters('jumpbox-os'), 'Linux')]",
                  "dependsOn": [
                    "[resourceId('Microsoft.Compute/virtualMachines', parameters('linux-virtualMachine-name-prefix'))]"
                  ],
                  "properties": {
                    "storageAccountId": "[resourceId(parameters('oms-workspace-resourceGroup'), 'Microsoft.Storage/storageAccounts', parameters('diagnostic-storageAccount-name'))]",
                    "workspaceId": "[if(parameters('noLogAnalytics'), json('null'), resourceId(variables('oms-workspace-resourceGroup'), 'Microsoft.OperationalInsights/workspaces', variables('oms-workspace-name')))]",
                    "metrics": [
                      {
                        "category": "AllMetrics",
                        "enabled": true,
                        "retentionPolicy": {
                          "enabled": true,
                          "days": "[parameters('logs-retention-in-days')]"
                        }
                      }
                    ],
                    "logs": []
                  }
                },
                {
                  "apiVersion": "2018-06-30-preview",
                  "type": "Microsoft.Compute/virtualMachines/providers/guestConfigurationAssignments",
                  "condition": "[and(equals(parameters('jumpbox-os'), 'Linux'), not(parameters('isOffline')))]",
                  "name": "[concat(parameters('linux-virtualMachine-name-prefix'), '/Microsoft.GuestConfiguration/', parameters('linux-audit-remote-connection-with-no-pwd-config-name'))]",
                  "dependsOn": [
                    "[resourceId('Microsoft.Compute/virtualMachines', parameters('linux-virtualMachine-name-prefix'))]",
                    "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('linux-virtualMachine-name-prefix'), parameters('linuxOMSExtensionName'))]"
                  ],
                  "location": "[resourceGroup().location]",
                  "properties": {
                    "guestConfiguration": {
                      "name": "[parameters('linux-audit-remote-connection-with-no-pwd-config-name')]",
                      "version": "1.*"
                    }
                  }
                },
                {
                  "apiVersion": "2018-06-30-preview",
                  "type": "Microsoft.Compute/virtualMachines/providers/guestConfigurationAssignments",
                  "condition": "[and(equals(parameters('jumpbox-os'), 'Linux'), not(parameters('isOffline')))]",
                  "name": "[concat(parameters('linux-virtualMachine-name-prefix'), '/Microsoft.GuestConfiguration/', parameters('linux-audit-accounts-with-no-pwd-config-name'))]",
                  "dependsOn": [
                    "[resourceId('Microsoft.Compute/virtualMachines', parameters('linux-virtualMachine-name-prefix'))]",
                    "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('linux-virtualMachine-name-prefix'), parameters('linuxOMSExtensionName'))]"
                  ],
                  "location": "[resourceGroup().location]",
                  "properties": {
                    "guestConfiguration": {
                      "name": "[parameters('linux-audit-accounts-with-no-pwd-config-name')]",
                      "version": "1.*"
                    }
                  }
                },
                {
                  "apiVersion": "2018-06-30-preview",
                  "type": "Microsoft.Compute/virtualMachines/providers/guestConfigurationAssignments",
                  "condition": "[and(equals(parameters('jumpbox-os'), 'Linux'), not(parameters('isOffline')))]",
                  "name": "[concat(parameters('linux-virtualMachine-name-prefix'), '/Microsoft.GuestConfiguration/', parameters('linux-audit-etc-passwd-file-permission-set-to-0644-config-name'))]",
                  "dependsOn": [
                    "[resourceId('Microsoft.Compute/virtualMachines', parameters('linux-virtualMachine-name-prefix'))]",
                    "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('linux-virtualMachine-name-prefix'), parameters('linuxOMSExtensionName'))]"
                  ],
                  "location": "[resourceGroup().location]",
                  "properties": {
                    "guestConfiguration": {
                      "name": "[parameters('linux-audit-etc-passwd-file-permission-set-to-0644-config-name')]",
                      "version": "1.*"
                    }
                  }
                },
                {
                  "apiVersion": "2019-07-01",
                  "name": "[concat(parameters('linux-virtualMachine-name-prefix'), '/', parameters('linuxAzurePolicy'))]",
                  "condition": "[and(equals(parameters('jumpbox-os'), 'Linux'), not(parameters('isOffline')))]",
                  "type": "Microsoft.Compute/virtualMachines/extensions",
                  "location": "[resourceGroup().location]",
                  "dependsOn": [
                    "[resourceId('Microsoft.Compute/virtualMachines', parameters('linux-virtualMachine-name-prefix'))]",
                    "[concat('Microsoft.Compute/virtualMachines/', parameters('linux-virtualMachine-name-prefix'),'/providers/Microsoft.GuestConfiguration/guestConfigurationAssignments/',parameters('linux-audit-remote-connection-with-no-pwd-config-name'))]",
                    "[concat('Microsoft.Compute/virtualMachines/', parameters('linux-virtualMachine-name-prefix'),'/providers/Microsoft.GuestConfiguration/guestConfigurationAssignments/',parameters('linux-audit-accounts-with-no-pwd-config-name'))]",
                    "[concat('Microsoft.Compute/virtualMachines/', parameters('linux-virtualMachine-name-prefix'),'/providers/Microsoft.GuestConfiguration/guestConfigurationAssignments/',parameters('linux-audit-etc-passwd-file-permission-set-to-0644-config-name'))]",
                    "[resourceId('Microsoft.Compute/virtualMachines/extensions',parameters('linux-virtualMachine-name-prefix'), parameters('linuxOMSExtensionName'))]"
                  ],
                  "properties": {
                    "publisher": "Microsoft.GuestConfiguration",
                    "type": "ConfigurationforLinux",
                    "typeHandlerVersion": "1.0",
                    "autoUpgradeMinorVersion": true
                  }
                },
                {
                  "name": "[concat(parameters('linux-virtualMachine-name-prefix'), '/', parameters('linuxStigExtensionName'))]",
                  "type": "Microsoft.Compute/virtualMachines/extensions",
                  "condition": "[and(equals(parameters('jumpbox-os'), 'Linux'), not(parameters('isOffline')))]",
                  "dependsOn": [
                    "[resourceId('Microsoft.Compute/virtualMachines', parameters('linux-virtualMachine-name-prefix'))]",
                    "[resourceId('Microsoft.Compute/virtualMachines/extensions/', parameters('linux-virtualMachine-name-prefix'), parameters('linuxAzurePolicy'))]"
                  ],
                  "location": "[resourceGroup().location]",
                  "apiVersion": "2019-03-01",
                  "tags": {
                    "displayName": "config-app"
                  },
                  "properties": {
                    "publisher": "Microsoft.Azure.Extensions",
                    "type": "CustomScript",
                    "typeHandlerVersion": "2.0",
                    "autoUpgradeMinorVersion": true,
                    "settings": {
                      "skipDos2Unix": true,
                      "timestamp": 123456789
                    },
                    "protectedSettings": {
                      "fileUris": "[parameters('file-uris')]",
                      "commandToExecute": "[concat('bash ', parameters('apply-stig-script'))]"
                    }
                  }
                },
                {
                  "type": "Microsoft.Compute/virtualMachines/extensions",
                  "name": "[concat('/', parameters('linux-virtualMachine-name-prefix'), '/', parameters('linuxDiskEncryptionExtensionName'))]",
                  "location": "[resourceGroup().location]",
                  "condition": "[and(parameters('linuxUseDiskEncryption'), bool(equals(parameters('jumpbox-os'), 'Linux')), bool(equals(parameters('disk-encryption-type'), 'ADE')), not(parameters('isOffline')))]",
                  "dependsOn": [
                    "[resourceId('Microsoft.Compute/virtualMachines', parameters('linux-virtualMachine-name-prefix'))]",
                    "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('linux-virtualMachine-name-prefix'), parameters('linuxOMSExtensionName'))]",
                    "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('linux-virtualMachine-name-prefix'), parameters('linuxStigExtensionName'))]"
                  ],
                  "apiVersion": "2019-07-01",
                  "properties": {
                    "publisher": "Microsoft.Azure.Security",
                    "type": "[parameters('linuxDiskEncryptionExtensionName')]",
                    "typeHandlerVersion": "[parameters('linuxDiskEncryptionExtensionVersion')]",
                    "autoUpgradeMinorVersion": true,
                    "forceUpdateTag": "[parameters('utcValue')]",
                    "settings": {
                      "EncryptionOperation": "[parameters('linuxEncryptionOperation')]",
                      "KeyVaultURL": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('key-vault-name')), '2019-09-01').vaultUri]",
                      "KeyVaultResourceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('key-vault-name'))]",
                      "KeyEncryptionKeyURL": "[parameters('disk-key-encryption-key-url')]",
                      "KekVaultResourceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('key-vault-name'))]",
                      "KeyEncryptionAlgorithm": "[parameters('linuxKeyEncryptionAlgorithm')]",
                      "VolumeType": "All"
                    }
                  }
                }
              ]
            },
            "parameters": {
              "jumpbox-os": {
                "value": "[parameters('jumpbox-os')]"
              },
              "jumpbox-local-admin-username": {
                "value": "[parameters('jumpbox-local-admin-username')]"
              },
              "jumpbox-local-admin-password": {
                "reference": {
                  "keyVault": {
                    "id": "[resourceId('Microsoft.KeyVault/vaults', variables('key-vault-name'))]"
                  },
                  "secretName": "jb-admin-user-password"
                }
              },
              "disk-key-encryption-key-url": {
                "reference": {
                  "keyVault": {
                    "id": "[resourceId('Microsoft.KeyVault/vaults', variables('key-vault-name'))]"
                  },
                  "secretName": "disk-key-kek-kid"
                }
              },
              "linux-authentication-type": {
                "value": "[parameters('linux-authentication-type')]"
              },
              "linux-admin-ssh": {
                "value": "[parameters('linux-admin-ssh')]"
              },
              "linux-virtualMachine-name-prefix": {
                "value": "[variables('linux-virtualMachine-name-prefix')]"
              },
              "virtualMachine-size": {
                "value": "[variables('virtualMachine-size')]"
              },
              "uniqueString": {
                "value": "[variables('uniqueString')]"
              },
              "oms-workspace-resourceGroup": {
                "value": "[variables('oms-workspace-resourceGroup')]"
              },
              "diagnostic-storageAccount-name": {
                "value": "[variables('diagnostic-storageAccount-name')]"
              },
              "linux-availabilitySet-name": {
                "value": "[variables('linux-availabilitySet-name')]"
              },
              "extension-name": {
                "value": "[variables('extension-name')]"
              },
              "managed-disk-json": {
                "value": "[variables('managed-disk-json')]"
              },
              "disk-encryption-type": {
                "value": "[parameters('disk-encryption-type')]"
              },
              "linuxDiskEncryptionExtensionName": {
                "value": "[variables('linuxDiskEncryptionExtensionName')]"
              },
              "linuxUseDiskEncryption": {
                "value": "[variables('linuxUseDiskEncryption')]"
              },
              "linuxDiskEncryptionExtensionVersion": {
                "value": "[variables('linuxDiskEncryptionExtensionVersion')]"
              },
              "linuxEncryptionOperation": {
                "value": "[variables('linuxEncryptionOperation')]"
              },
              "linuxKeyEncryptionAlgorithm": {
                "value": "[variables('linuxKeyEncryptionAlgorithm')]"
              },
              "key-vault-name": {
                "value": "[variables('key-vault-name')]"
              },
              "utcValue": {
                "value": "[parameters('utcValue')]"
              },
              "linuxOMSExtensionName": {
                "value": "[variables('linuxOMSExtensionName')]"
              },
              "linuxOMSExtensionType": {
                "value": "[variables('linuxOMSExtensionType')]"
              },
              "linuxOMSExtensionTypeHandlerVersion": {
                "value": "[variables('linuxOMSExtensionTypeHandlerVersion')]"
              },
              "linuxOMSExtensionPublisher": {
                "value": "[variables('linuxOMSExtensionPublisher')]"
              },
              "linux-audit-remote-connection-with-no-pwd-config-name": {
                "value": "[variables('linux-audit-remote-connection-with-no-pwd-config-name')]"
              },
              "oms-workspace-name": {
                "value": "[variables('oms-workspace-name')]"
              },
              "linux-audit-accounts-with-no-pwd-config-name": {
                "value": "[variables('linux-audit-accounts-with-no-pwd-config-name')]"
              },
              "linux-audit-etc-passwd-file-permission-set-to-0644-config-name": {
                "value": "[variables('linux-audit-etc-passwd-file-permission-set-to-0644-config-name')]"
              },
              "linuxAzurePolicy": {
                "value": "[variables('linuxAzurePolicy')]"
              },
              "linuxStigExtensionName": {
                "value": "[variables('linuxStigExtensionName')]"
              },
              "apply-stig-script": {
                "value": "[variables('apply-stig-script')]"
              },
              "file-uris": {
                "value": "[variables('file-uris')]"
              },
              "logs-retention-in-days": {
                "value": "[parameters('logs-retention-in-days')]"
              },
              "stig-script-name": {
                "value": "[parameters('stig-script-name')]"
              },
              "isOffline": {
                "value": "[parameters('isOffline')]"
              }
            }
          }
        },
        {
          "apiVersion": "2019-09-01",
          "name": "nestedDeployCreateAzureFwRules",
          "type": "Microsoft.Resources/deployments",
          "condition": "[and(equals(parameters('jumpbox-os'), 'Linux'), not(parameters('isOffline')))]",
          "resourceGroup": "[variables('vnet-resourceGroup')]",
          "subscriptionId": "[subscription().subscriptionId]",
          "dependsOn": [
            "[if(equals(parameters('jumpbox-os'), 'Linux'), resourceId('Microsoft.Resources/deployments', variables('linux-virtualMachine-name-prefix')), resourceId('Microsoft.Resources/deployments', variables('windows-virtualMachine-name-prefix')))]"
          ],
          "properties": {
            "mode": "Incremental",
            "template": {
              "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
              "contentVersion": "1.0.0.0",
              "parameters": {},
              "variables": {},
              "resources": [
                {
                  "type": "Microsoft.Network/azureFirewalls",
                  "apiVersion": "2019-11-01",
                  "location": "[resourceGroup().location]",
                  "name": "[variables('azure-fw-name')]",
                  "properties": {
                    "ipConfigurations": "[if(parameters('isOffline'), '', reference(resourceId(subscription().subscriptionId, variables('vnet-resourceGroup'), 'Microsoft.Network/azureFirewalls', variables('azure-fw-name')), '2018-08-01').ipConfigurations)]",
                    "applicationRuleCollections": "[if(parameters('isOffline'), '', reference(resourceId(subscription().subscriptionId, variables('vnet-resourceGroup'), 'Microsoft.Network/azureFirewalls', variables('azure-fw-name')), '2018-08-01').applicationRuleCollections)]",
                    "natRuleCollections": [
                      {
                        "name": "allow-ingress-access",
                        "properties": {
                          "priority": "101",
                          "action": {
                            "type": "Dnat"
                          },
                          "rules": [
                            {
                              "name": "allow-external-win-jb-access",
                              "sourceAddresses": [
                                "*"
                              ],
                              "destinationAddresses": [
                                "[if(parameters('isOffline'), '', reference(resourceId(subscription().subscriptionId, variables('vnet-resourceGroup'), 'Microsoft.Network/publicIPAddresses', variables('azure-fw-pip-name')), '2017-10-01').ipAddress)]"
                              ],
                              "destinationPorts": [
                                "[if(equals(parameters('jumpbox-os'), 'Linux'), '22', '3389')]"
                              ],
                              "protocols": [
                                "TCP"
                              ],
                              "translatedAddress": "[reference(resourceId(subscription().subscriptionId, variables('jb-resourceGroup'), 'Microsoft.Network/networkInterfaces', if(equals(parameters('jumpbox-os'), 'Linux'), concat(variables('linux-virtualMachine-name-prefix'), '-bastion-nic'), concat(variables('windows-virtualMachine-name-prefix'), '-bastion-nic'))), '2017-09-01').ipConfigurations[0].properties.privateIpAddress]",
                              "translatedPort": "[if(equals(parameters('jumpbox-os'), 'Linux'), '22', '3389')]"
                            }
                          ]
                        }
                      }
                    ]
                  }
                }
              ]
            }
          }
        }
      ],
      "outputs": {}
    },
    "parameters": {
      "resourcePrefix": {
        "value": "[parameters('resourcePrefix')]"
      },
      "jumpbox-local-admin-username": {
        "value": "[parameters('jumpbox_jumpbox-local-admin-username')]"
      },
      "jumpbox-os": {
        "value": "[parameters('jumpbox_jumpbox-os')]"
      },
      "linux-authentication-type": {
        "value": "[parameters('jumpbox_linux-authentication-type')]"
      },
      "linux-admin-ssh": {
        "value": "[parameters('jumpbox_linux-admin-ssh')]"
      },
      "logs-retention-in-days": {
        "value": "[parameters('jumpbox_logs-retention-in-days')]"
      },
      "artifact-storage-account-uri": {
        "value": "[parameters('artifact-storage-account-uri')]"
      },
      "disk-encryption-type": {
        "value": "[parameters('jumpbox_disk-encryption-type')]"
      }
    },
    "dependsOn": [
      "net",
      "keyvault",
      "azure-firewall"
    ],
    "resourceGroup": "ResourceGroup",
    "displayName": "Jumpbox template",
    "description": ""
  },
  "kind": "template",
  "id": "/providers/Microsoft.Blueprint/blueprints/bce24a0e-4bb8-45bd-b705-8493e0180a34/artifacts/jumpbox",
  "type": "Microsoft.Blueprint/blueprints/artifacts",
  "name": "jumpbox"
}